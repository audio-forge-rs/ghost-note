# Claude Code Review Workflow
# Automatically reviews PRs using Claude
# https://github.com/anthropics/claude-code-action

name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

# Restrict permissions for security
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  claude-review:
    # Only run on PRs or when @claude is mentioned
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # Custom review instructions
          custom_instructions: |
            You are reviewing code for Ghost Note, a poetry-to-song translation app.

            ## Review Focus Areas
            1. **Correctness**: Does the code do what the issue requires?
            2. **Completeness**: Is the implementation full, not oversimplified?
            3. **Testing**: Are there adequate tests?
            4. **Logging**: Is there debug logging for troubleshooting?
            5. **Edge Cases**: Are corner cases handled?
            6. **No Regression**: Does this remove or break existing functionality?
            7. **Code Style**: TypeScript strict, 2-space indent, functional React

            ## Project Context
            - Frontend: React + TypeScript + Vite
            - Styling: Tailwind CSS
            - State: Zustand
            - Music: abcjs for ABC notation
            - NLP: compromise, CMU dictionary

            ## Key Principles
            - Large scope and thorough implementation is GOOD
            - Adding logging is GOOD
            - Handling corner cases explicitly is GOOD
            - Simplifying or removing functionality is BAD
            - Cutting corners is BAD

            ## Review Style
            - Be specific about what needs to change
            - Explain WHY something should change
            - Approve if implementation is solid
            - Request changes only for real issues

          # Trigger on PR events and @claude mentions
          trigger_phrase: "@claude"

          # Include these files in review context
          include_patterns: |
            src/**/*.ts
            src/**/*.tsx
            docs/**/*.md
            CLAUDE.md
            WORKER_CLAUDE.md

          # Exclude from review
          exclude_patterns: |
            node_modules/**
            dist/**
            *.lock
            *.log

  # Security review for sensitive changes
  security-review:
    if: |
      github.event_name == 'pull_request' &&
      (contains(github.event.pull_request.title, 'auth') ||
       contains(github.event.pull_request.title, 'security') ||
       contains(github.event.pull_request.changed_files, '.env'))
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Claude Security Review
        uses: anthropics/claude-code-security-review@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          severity_threshold: medium
